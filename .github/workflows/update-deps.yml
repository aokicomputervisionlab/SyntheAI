name: Auto Dependency Update

on:
  schedule:
    - cron: '0 0 1 1,4,7,10 *' # 1,4,7,10月の1日 00:00
  workflow_dispatch:

jobs:
  update-requirements:
    runs-on: self-hosted
    container:
      image: nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04
      options: --gpus all --shm-size=8gb
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Python and pip-tools
        run: |
          apt-get update && apt-get install -y python3-pip
          python3 -m pip install pip-tools

      - name: Update requirements and README
        working-directory: py3
        run: |
          # 1. Backup old requirements
          cp requirements.txt requirements.txt.bak || touch requirements.txt.bak
          
          # 2. Upgrade dependencies
          pip-compile --upgrade requirements.in --output-file requirements.txt
          
          # 3. Generate Diff
          DIFF=$(diff requirements.txt.bak requirements.txt | grep ">" | sed 's/> //' || true)
          
          if [ -n "$DIFF" ]; then
            DATE=$(date +'%Y-%m-%d')
            # 4. Create a temporary message file (This avoids "sed" escaping hell)
            echo "### Updated on $DATE" > msg.tmp
            echo '```' >> msg.tmp
            echo "$DIFF" >> msg.tmp
            echo '```' >> msg.tmp
            echo "" >> msg.tmp
            
            # 5. Inject the message file into README.md using the 'r' command
            # This reads msg.tmp and appends it after the tag
            sed -i "//r msg.tmp" ../README.md
            
            # Clean up
            rm msg.tmp
          fi
      - name: Verify Environment (GPU & OpenCV)
        working-directory: py3
        run: |
          # 1. Install newly generated requirements
          python3 -m pip install -r requirements.txt
          
          # 2. Test PyTorch GPU access
          echo "Testing PyTorch..."
          python3 -c "import torch; print(f'PyTorch GPU: {torch.cuda.is_available()}'); assert torch.cuda.is_available(), 'PyTorch cannot see GPU!'"
          
          # 3. Test TensorFlow GPU access
          echo "Testing TensorFlow..."
          python3 -c "import tensorflow as tf; gpus = tf.config.list_physical_devices('GPU'); print(f'TF GPUs: {gpus}'); assert len(gpus) > 0, 'TensorFlow cannot see GPU!'"
          
          # 4. Test OpenCV import
          echo "Testing OpenCV..."
          python3 -c "import cv2; print(f'OpenCV Version: {cv2.__version__}')"
      # Permissions Update
      - name: Fix Permissions for Rootless
        run: chown -R $(id -u):$(id -g) .

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update requirements.txt and README"
          title: "依存ライブラリとREADMEの定期更新"
          body: |
            `pip-compile` によって依存関係が最新化されました。
            README.md に更新内容を追記しています。
            動作確認後にマージしてください。
          branch: "auto-update-dependencies"
          delete-branch: true
