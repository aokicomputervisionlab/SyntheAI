name: Auto Dependency Update

on:
  schedule:
    - cron: '0 3 1 1,4,7,10 *' # JST 12:00 (UTC 03:00)
  workflow_dispatch:
permissions:
  contents: write
jobs:
  update-requirements:
    runs-on: self-hosted
    container:
      image: tensorflow/tensorflow:2.15.0.post1-gpu
      options: --gpus all --shm-size=8589934592
      env:
        TZ: Asia/Tokyo
        DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          apt-get update && apt-get install -y \
            tzdata \
            git \
            wget \
            ffmpeg \
            libglib2.0-0 \
            libsm6 \
            libxrender1 \
            libxext6 \
            libgl1-mesa-dev \
            && rm -rf /var/lib/apt/lists/*
          
          # pip-toolssetup
          pip install --upgrade pip
          pip install pip-tools

      - name: Update requirements and README
        working-directory: py3
        run: |
          # 1. Move and backup (using -f to ignore error if not exists)
          cp -f requirements.txt requirements.txt.bak || touch requirements.txt.bak
          
          # 2. Run pip-compile (Upgrade)
          pip-compile --strip-extras --upgrade \
            --unsafe-package nvidia-cublas-cu12 \
            --unsafe-package nvidia-cuda-cupti-cu12 \
            --unsafe-package nvidia-cuda-nvcc-cu12 \
            --unsafe-package nvidia-cuda-nvrtc-cu12 \
            --unsafe-package nvidia-cuda-runtime-cu12 \
            --unsafe-package nvidia-cudnn-cu12 \
            --unsafe-package nvidia-cufft-cu12 \
            --unsafe-package nvidia-curand-cu12 \
            --unsafe-package nvidia-cusolver-cu12 \
            --unsafe-package nvidia-cusparse-cu12 \
            --unsafe-package nvidia-nccl-cu12 \
            --unsafe-package nvidia-nvtx-cu12 \
            requirements.in --output-file requirements.txt
          
          # 3. Calculate Diff and create temporary message file
          DIFF=$(diff requirements.txt.bak requirements.txt | grep "^> " | grep -v "> #" | sed 's/> //' || true)
          
          if [ -n "$DIFF" ]; then
            DATE=$(date +'%Y-%m-%d')
            # Create a clean message file
            echo -e "\n### Updated on $DATE\n\`\`\`\n$DIFF\n\`\`\`" > msg.tmp
            
            # 4. INJECT using 'r' command
            # This inserts the ENTIRE content of msg.tmp after the tag
            # We use the exact tag: sed -i "//r msg.tmp" ../README.md
            sed -i "/## 依存関係の更新履歴/r msg.tmp" ../README.md
            # Clean up
            rm msg.tmp
          else
            echo "No updates found. Skipping README update."
          fi
      - name: Verify Environment (GPU & OpenCV)
        working-directory: py3
        run: |
          # 1. Install newly generated requirements
          pip install -r requirements.txt
          # 4.TESTCODE
          echo "--- Testing PyTorch ---"
          python3 -c "import torch; print(f'PyTorch GPU: {torch.cuda.is_available()}'); assert torch.cuda.is_available(), 'PyTorch cannot see GPU!'"
          python3 -c "import torch; x = torch.ones(1).cuda(); print(f'GPU computing: {x + x}')"
          echo "--- Testing TensorFlow ---"
          TF_CPP_MIN_LOG_LEVEL=3 python3 -c "
          import os
          import tensorflow as tf
          gpus = tf.config.list_physical_devices('GPU')
          print(f'TF GPUs found: {gpus}')
          
          if not gpus:
              print('Detailed debug: No GPU detected by TF.')
              exit(1)
              
          with tf.device('/GPU:0'):
              a = tf.constant([[1.0, 2.0], [3.0, 4.0]])
              b = tf.constant([[1.0, 1.0], [0.0, 1.0]])
              c = tf.matmul(a, b)
              print(f'TF Computing Success! Result:\n{c}')
          "
          echo "--- Testing JAX ---"
          python3 -c "import jax; print(f'JAX backend: {jax.lib.xla_bridge.get_backend().platform}'); print(f'JAX Devices: {jax.devices()}'); assert jax.lib.xla_bridge.get_backend().platform == 'gpu'"
          python3 -c "import jax.numpy as jnp; x = jnp.ones((1,)); print(f'JAX computing: {x + x}')"
          echo "--- Testing OpenCV ---"
          python3 -c "import cv2; print(f'OpenCV Version: {cv2.__version__}')"      
      # Permissions Update
      - name: Fix Permissions for Rootless
        run: chown -R $(id -u):$(id -g) .

      - name: Commit and Push (The Nuclear Option)
        # ここで Git の「境界線」を力業で突破します
        run: |
          # 1. 絶対パスに移動
          cd ${{ github.workspace }}
          
          # 2. 境界線エラー（128）を殺すための環境変数をセット
          export GIT_DISCOVERY_ACROSS_FILESYSTEM=1
          
          # 3. Gitの設定を再定義
          git config --global --add safe.directory '*'
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # 4. デバッグ：.git が本当にあるか執拗に確認
          if [ ! -d ".git" ]; then
            echo "CRITICAL ERROR: .git still missing. Initializing dummy git to force push."
            git init
            git remote add origin https://github.com/${{ github.repository }}.git
          fi
          
          # 5. README 更新（Diff 計算）
          cd py3
          DIFF=$(diff -u requirements.txt.bak requirements.txt | grep '^\+' | grep -v '+++' | sed 's/^+//' || true)
          if [ -n "$DIFF" ]; then
            echo -e "\n### Updated on ${{ env.DATE }}\n\`\`\`\n$DIFF\n\`\`\`" > msg.tmp
            sed -i "/## 依存関係の更新履歴/r msg.tmp" ../README.md
            rm msg.tmp
          fi
          
          # 6. コミット & プッシュ
          cd ${{ github.workspace }}
          git add py3/requirements.txt README.md
          if ! git diff --staged --quiet; then
            git commit -m "chore: 依存ライブラリとREADMEを自動更新 (Boundary Breaker)"
            git push origin HEAD:${{ github.ref_name }}
            echo "PUSH SUCCESSFUL!!! おらぁあああ！"
          else
            echo "No changes detected."
          fi