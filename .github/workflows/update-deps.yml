name: Auto Dependency Update

on:
  schedule:
    - cron: '0 0 1 1,4,7,10 *' # 1,4,7,10月の1日 00:00
  workflow_dispatch:

jobs:
  update-requirements:
    runs-on: self-hosted
    container:
      image: nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04
      options: --gpus all --shm-size=8589934592
      env:
        TZ: Asia/Tokyo
        DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          apt-get update && apt-get install -y \
            python3-pip \
            tzdata \
            git \
            wget \
            ffmpeg \
            libglib2.0-0 \
            libsm6 \
            libxrender1 \
            libxext6 \
            libgl1-mesa-dev
          
          # pip-toolssetup
          python3 -m pip install --upgrade pip
          python3 -m pip install pip-tools

      - name: Update requirements and README
        working-directory: py3
        run: |
          # 1. Move and backup (using -f to ignore error if not exists)
          cp -f requirements.txt requirements.txt.bak || touch requirements.txt.bak
          
          # 2. Run pip-compile (Upgrade)
          pip-compile --upgrade requirements.in --output-file requirements.txt
          
          # 3. Calculate Diff and create temporary message file
          DIFF=$(diff requirements.txt.bak requirements.txt | grep ">" | sed 's/> //' || true)
          
          if [ -n "$DIFF" ]; then
            DATE=$(date +'%Y-%m-%d')
            # Create a clean message file
            echo -e "\n### Updated on $DATE\n\`\`\`\n$DIFF\n\`\`\`" > msg.tmp
            
            # 4. INJECT using 'r' command
            # This inserts the ENTIRE content of msg.tmp after the tag
            # We use the exact tag: sed -i "//r msg.tmp" ../README.md
            
            # Clean up
            rm msg.tmp
          else
            echo "No updates found. Skipping README update."
          fi
      - name: Verify Environment (GPU & OpenCV)
        working-directory: py3
        run: |
          # 1. Install newly generated requirements
          python3 -m pip install -r requirements.txt
          
          # 2. Test PyTorch GPU access
          echo "--- Testing PyTorch ---"
          python3 -c "import torch; print(f'PyTorch GPU: {torch.cuda.is_available()}'); assert torch.cuda.is_available(), 'PyTorch cannot see GPU!'"
          python3 -c "import torch; x = torch.ones(1).cuda(); print(f'GPU computing: {x + x}')"

          # 3. Test TensorFlow GPU access
          echo "--- Testing TensorFlow ---"
          python3 -c "import tensorflow as tf; gpus = tf.config.list_physical_devices('GPU'); print(f'TF GPUs: {gpus}'); assert len(gpus) > 0, 'TensorFlow cannot see GPU!'"
          # 実際に簡単な行列演算をGPUで実行
          python3 -c "import tensorflow as tf; with tf.device('/GPU:0'): x = tf.ones([1]); print(f'TF computing: {x + x}')"
          
          # 4. Test JAX GPU access
          echo "--- Testing JAX ---"
          python3 -c "import jax; print(f'JAX Devices: {jax.devices()}'); assert any('gpu' in str(d).lower() for d in jax.devices()), 'JAX cannot see GPU!'"
          python3 -c "import jax.numpy as jnp; x = jnp.ones((1,)); print(f'JAX computing: {x + x}')"

          # 5. Test OpenCV import
          echo "--- Testing OpenCV ---"
          python3 -c "import cv2; print(f'OpenCV Version: {cv2.__version__}')"      # Permissions Update
      - name: Fix Permissions for Rootless
        run: chown -R $(id -u):$(id -g) .

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update requirements.txt and README"
          title: "依存ライブラリとREADMEの定期更新"
          body: |
            `pip-compile` によって依存関係が最新化されました。
            README.md に更新内容を追記しています。
            動作確認後にマージしてください。
          branch: "auto-update-dependencies"
          delete-branch: true
