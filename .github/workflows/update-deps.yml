name: Auto Dependency Update

on:
  schedule:
    - cron: '0 0 1 1,4,7,10 *' # 1,4,7,10月の1日 00:00
  workflow_dispatch:
permissions:
  contents: write
jobs:
  update-requirements:
    runs-on: self-hosted
    container:
      image: nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04
      options: --gpus all --shm-size=8589934592
      env:
        TZ: Asia/Tokyo
        DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          apt-get update && apt-get install -y \
            python3-pip \
            tzdata \
            git \
            wget \
            ffmpeg \
            libglib2.0-0 \
            libsm6 \
            libxrender1 \
            libxext6 \
            libgl1-mesa-dev
          
          # pip-toolssetup
          python3 -m pip install --upgrade pip
          python3 -m pip install pip-tools

      - name: Update requirements and README
        working-directory: py3
        run: |
          # 1. Move and backup (using -f to ignore error if not exists)
          cp -f requirements.txt requirements.txt.bak || touch requirements.txt.bak
          
          # 2. Run pip-compile (Upgrade)
          pip-compile --strip-extras --upgrade requirements.in --output-file requirements.txt
          
          # 3. Calculate Diff and create temporary message file
          DIFF=$(diff requirements.txt.bak requirements.txt | grep ">" | sed 's/> //' || true)
          
          if [ -n "$DIFF" ]; then
            DATE=$(date +'%Y-%m-%d')
            # Create a clean message file
            echo -e "\n### Updated on $DATE\n\`\`\`\n$DIFF\n\`\`\`" > msg.tmp
            
            # 4. INJECT using 'r' command
            # This inserts the ENTIRE content of msg.tmp after the tag
            # We use the exact tag: sed -i "//r msg.tmp" ../README.md
            sed -i "/## 依存関係の更新履歴/r msg.tmp" ../README.md
            # Clean up
            rm msg.tmp
          else
            echo "No updates found. Skipping README update."
          fi
      - name: Verify Environment (GPU & OpenCV)
        working-directory: py3
        run: |
          # 1. Install newly generated requirements
          python3 -m pip install -r requirements.txt
          # 2. CUDA 12 REMOVE
          echo "Removing CUDA 12 leftovers to prevent conflicts..."
          rm -rf /usr/local/lib/python3.10/dist-packages/nvidia/*-cu12
          
          # 3. Setting CUDA11.8
          export LD_LIBRARY_PATH=/usr/local/lib/python3.10/dist-packages/nvidia/cudnn/lib:/usr/local/lib/python3.10/dist-packages/nvidia/cublas/lib:$LD_LIBRARY_PATH# 2. Test PyTorch GPU access
          # 4.TESTCODE
          echo "--- Testing PyTorch ---"
          python3 -c "import torch; print(f'PyTorch GPU: {torch.cuda.is_available()}'); assert torch.cuda.is_available(), 'PyTorch cannot see GPU!'"
          python3 -c "import torch; x = torch.ones(1).cuda(); print(f'GPU computing: {x + x}')"

          echo "--- Testing TensorFlow ---"
          TF_CPP_MIN_LOG_LEVEL=2 python3 -c "import tensorflow as tf; gpus = tf.config.list_physical_devices('GPU'); print(f'TF GPUs: {gpus}'); assert len(gpus) > 0"
          TF_CPP_MIN_LOG_LEVEL=2 python3 -c "import tensorflow as tf; with tf.device('/GPU:0'): x = tf.ones([1]); print(f'TF computing: {x + x}')"
          
          echo "--- Testing JAX ---"
          python3 -c "import jax; print(f'JAX backend: {jax.lib.xla_bridge.get_backend().platform}'); print(f'JAX Devices: {jax.devices()}'); assert jax.lib.xla_bridge.get_backend().platform == 'gpu'"
          python3 -c "import jax.numpy as jnp; x = jnp.ones((1,)); print(f'JAX computing: {x + x}')"
          echo "--- Testing OpenCV ---"
          python3 -c "import cv2; print(f'OpenCV Version: {cv2.__version__}')"      
      # Permissions Update
      - name: Fix Permissions for Rootless
        run: chown -R $(id -u):$(id -g) .

      - name: Commit and Push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # fille PUSH PROCESS
          git add py3/requirements.txt README.md
          if ! git diff --staged --quiet; then
            git commit -m "chore: 依存ライブラリとREADMEを自動更新 ($(date +'%Y-%m-%d'))"
            git push
            echo "Changes pushed to repository."
          else
            echo "No changes to commit."
          fi
